name: Create Chapter

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Filename'
        required: true
        type: string
      index:
        description: 'Index (optional, position)'
        required: false
        type: string

jobs:
   create-chapter:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
           with:
            ref: main
         - uses: denoland/setup-deno@v1
           with:
            deno-version: latest

         - name: Get last index
           id: last-index
           run: |
            if [ -z "${{ github.event.inputs.index }}" ]; then
            last_index=$(ls *.md | grep -v 'README.md' | wc -l)
            index=$((last_index + 1))
            else
            index="${{ github.event.inputs.index }}"
            fi
            echo "index=$index" >> "$GITHUB_OUTPUT"
            echo "Final Index: $index"

         - name: Create chapter
           run: |
            deno run -A ./scripts/create-chapter.ts "${{ github.event.inputs.title }}" "${{ steps.last-index.outputs.index }}"
         - name: Commit changes
           run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Move chapter ${{ github.event.inputs.title }} to index ${{ github.event.inputs.index }}"
            git push
